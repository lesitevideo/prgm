# Protocole RS485

Format des messages échangés entre les ancres et la base (Raspberry Pi).

## Types de messages

| Type | Sync Byte | Direction | Description |
|------|-----------|-----------|-------------|
| Blink | 0xAA | Ancre → Base | Notification de réception blink |
| Sync | 0x55 | Maître → Esclaves | Synchronisation temporelle |
| Status | 0xBB | Ancre → Base | Status de l'ancre |
| Command | 0xCC | Base → Ancres | Commande de configuration |

---

## Message Blink (0xAA)

Envoyé par une ancre à chaque réception d'un blink UWB.

### Format

```
┌──────┬────────┬─────────┬────────┬───────────┬─────────┬───────┐
│ SYNC │ AncreID│ TagID   │ SeqNum │ Timestamp │ RSSI    │ CRC16 │
│ 0xAA │ 1 byte │ 2 bytes │ 2 bytes│ 5 bytes   │ 1 byte  │ 2 bytes│
└──────┴────────┴─────────┴────────┴───────────┴─────────┴───────┘
Total : 14 bytes
```

### Champs

| Offset | Taille | Champ | Description |
|--------|--------|-------|-------------|
| 0 | 1 | sync | 0xAA |
| 1 | 1 | anchor_id | ID de l'ancre (0x11-0x14, 0x21-0x24) |
| 2 | 2 | tag_id | ID du tag (little-endian) |
| 4 | 2 | seq_num | Numéro de séquence (little-endian) |
| 6 | 5 | timestamp | Timestamp UWB 40-bit (little-endian) |
| 11 | 1 | rssi | RSSI en dBm (signé) |
| 12 | 2 | crc | CRC-16-CCITT (little-endian) |

### Timestamp 40-bit

Le timestamp UWB est un compteur 40-bit à ~15.65 ps par tick.

```
Byte 6: bits 0-7   (LSB)
Byte 7: bits 8-15
Byte 8: bits 16-23
Byte 9: bits 24-31
Byte 10: bits 32-39 (MSB)
```

**Conversion en secondes** :

```python
TICK_PERIOD = 1 / (128 * 499.2e6)  # ~15.65 ps
timestamp_seconds = timestamp_raw * TICK_PERIOD
```

### Exemple

```
Ancre 0x11, Tag 0x0010, Seq 1234, Timestamp 0x1A2B3C4D5E, RSSI -45

Hex: AA 11 10 00 D2 04 5E 4D 3C 2B 1A D3 XX XX
     ^^ ^^ ^^^^^ ^^^^^ ^^^^^^^^^^^^^^^ ^^ ^^^^^
     Sy An TagID SeqNm Timestamp       RS CRC16
```

---

## Message Sync (0x55)

Envoyé par l'ancre maître pour synchroniser les esclaves.

### Format

```
┌──────┬────────┬───────────┬───────────┬───────┐
│ SYNC │ MasterID│ SyncCount │ Timestamp │ CRC16 │
│ 0x55 │ 1 byte │ 4 bytes   │ 5 bytes   │ 2 bytes│
└──────┴────────┴───────────┴───────────┴───────┘
Total : 13 bytes
```

### Champs

| Offset | Taille | Champ | Description |
|--------|--------|-------|-------------|
| 0 | 1 | sync | 0x55 |
| 1 | 1 | master_id | ID de l'ancre maître |
| 2 | 4 | sync_count | Compteur de sync (little-endian) |
| 6 | 5 | timestamp | Timestamp maître 40-bit |
| 11 | 2 | crc | CRC-16-CCITT |

---

## Message Status (0xBB)

Envoyé périodiquement par chaque ancre pour indiquer son état.

### Format

```
┌──────┬────────┬────────┬───────────┬──────────────┬───────┐
│ SYNC │ AncreID│ Status │ DriftPPM  │ LastSyncAge  │ CRC16 │
│ 0xBB │ 1 byte │ 1 byte │ 2 bytes   │ 2 bytes      │ 2 bytes│
└──────┴────────┴────────┴───────────┴──────────────┴───────┘
Total : 9 bytes
```

### Champs

| Offset | Taille | Champ | Description |
|--------|--------|-------|-------------|
| 0 | 1 | sync | 0xBB |
| 1 | 1 | anchor_id | ID de l'ancre |
| 2 | 1 | status | 0=OK, 1=DEGRADED, 2=ERROR |
| 3 | 2 | drift_ppm | Dérive en ppm (signé, little-endian) |
| 5 | 2 | last_sync_age | Age dernière sync en ms |
| 7 | 2 | crc | CRC-16-CCITT |

### Valeurs de status

| Valeur | Nom | Description |
|--------|-----|-------------|
| 0 | OK | Synchronisation normale |
| 1 | DEGRADED | Sync > 2s ou drift > 50 ppm |
| 2 | ERROR | Sync perdue (> 10s) ou erreur matérielle |

---

## Message Command (0xCC)

Envoyé par la base pour configurer les ancres.

### Format

```
┌──────┬────────┬─────────┬─────────────┬───────┐
│ SYNC │ Target │ CmdType │ Payload     │ CRC16 │
│ 0xCC │ 1 byte │ 1 byte  │ 0-8 bytes   │ 2 bytes│
└──────┴────────┴─────────┴─────────────┴───────┘
Total : 4-12 bytes
```

### Commandes

| CmdType | Nom | Payload | Description |
|---------|-----|---------|-------------|
| 0x01 | PING | - | Demande status |
| 0x02 | SET_ID | 1 byte | Change l'ID de l'ancre |
| 0x03 | SET_MASTER | 1 byte | 0=esclave, 1=maître |
| 0x04 | RESET | - | Reset de l'ancre |
| 0x10 | DEBUG_ON | - | Active mode debug |
| 0x11 | DEBUG_OFF | - | Désactive mode debug |

### Target

| Valeur | Signification |
|--------|---------------|
| 0x00 | Broadcast (toutes les ancres) |
| 0x11-0xFE | Ancre spécifique |

---

## Configuration RS485

### Paramètres série

| Paramètre | Valeur |
|-----------|--------|
| Baudrate | 115200 |
| Data bits | 8 |
| Parity | None |
| Stop bits | 1 |
| Flow control | None |

### Timing

| Paramètre | Valeur | Calcul |
|-----------|--------|--------|
| Durée 1 byte | 86.8 µs | 10 bits / 115200 |
| Durée msg blink (14 bytes) | 1.22 ms | 14 × 86.8 µs |
| Débit max | ~820 msg/s | 1 / 1.22 ms |

### Charge typique

| Scénario | Messages/s | Utilisation |
|----------|------------|-------------|
| 1 tag × 4 ancres × 30 Hz | 120 | 15% |
| 4 tags × 4 ancres × 30 Hz | 480 | 59% |
| 4 tags × 4 ancres × 40 Hz | 640 | 78% |

---

## Gestion des erreurs

### Resynchronisation

Si le parser détecte une erreur (CRC invalide, byte inattendu) :
1. Ignorer les bytes jusqu'au prochain sync byte (0xAA, 0x55, 0xBB, 0xCC)
2. Tenter de parser un message complet
3. Valider le CRC

### Timeout

| Condition | Action |
|-----------|--------|
| Pas de message d'une ancre > 1s | Alerte "ancre muette" |
| Pas de message d'un tag > 2s | Considérer tag hors zone |

---

## Code de référence

### Parser Python

```python
import struct

SYNC_BLINK = 0xAA
SYNC_SYNC = 0x55
SYNC_STATUS = 0xBB
MSG_SIZE_BLINK = 14

def parse_blink(data: bytes) -> dict | None:
    if len(data) != MSG_SIZE_BLINK:
        return None
    if data[0] != SYNC_BLINK:
        return None

    # Vérifier CRC
    if not verify_crc16(data):
        return None

    return {
        'anchor_id': data[1],
        'tag_id': struct.unpack('<H', data[2:4])[0],
        'seq_num': struct.unpack('<H', data[4:6])[0],
        'timestamp': int.from_bytes(data[6:11], 'little'),
        'rssi': struct.unpack('b', data[11:12])[0],
    }
```

### Builder C

```c
void build_blink_msg(uint8_t* buf, uint8_t anchor_id,
                     uint16_t tag_id, uint16_t seq_num,
                     uint64_t timestamp, int8_t rssi) {
    buf[0] = 0xAA;
    buf[1] = anchor_id;
    buf[2] = tag_id & 0xFF;
    buf[3] = (tag_id >> 8) & 0xFF;
    buf[4] = seq_num & 0xFF;
    buf[5] = (seq_num >> 8) & 0xFF;
    buf[6] = timestamp & 0xFF;
    buf[7] = (timestamp >> 8) & 0xFF;
    buf[8] = (timestamp >> 16) & 0xFF;
    buf[9] = (timestamp >> 24) & 0xFF;
    buf[10] = (timestamp >> 32) & 0xFF;
    buf[11] = rssi;

    uint16_t crc = crc16_ccitt(buf, 12);
    buf[12] = crc & 0xFF;
    buf[13] = (crc >> 8) & 0xFF;
}
```
